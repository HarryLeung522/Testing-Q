<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報價生成器 (單頁版)</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 15px; color: #555; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>報價生成器</h2>
        <p>生成單頁報價單 (Word 格式)</p>
        <button id="btn" onclick="generateQuote()">生成最新報價</button>
        <div id="status"></div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgpNUrOTp6zB9AtT5w7JJGV7rzyNiACFU4_Zji6JFflXhyyLbEoi1j247fzab4MkJ1YZlFxlZ-I7m9/pub?output=csv';

        async function generateQuote() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            status.innerText = "正在讀取資料...";

            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                const rows = parseCSV(csvText);

                // 取得最後一行資料
                const validRows = rows.filter(r => r.length > 1 && r[0].trim() !== "");
                if (validRows.length < 2) throw new Error("無效的資料來源");
                const lastRow = validRows[validRows.length - 1];

                // 資料映射
                const data = {
                    idSuffix: lastRow[0], // A行
                    school: lastRow[1],   // B行
                    teacher: lastRow[2],  // C行
                    course: lastRow[3],   // D行
                    date: lastRow[4],     // E行
                    lessons: lastRow[5],  // F行
                    grade: lastRow[6],    // G行 (文件對應為年級)
                    price: lastRow[7],    // H行
                    total: lastRow[9]     // J行
                };

                // 生成日期與編號
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const dateStr = `${yyyy}/${mm}/${dd}`;
                const quoteNo = `Q-${yyyy}${mm}${dd}${data.idSuffix}`;

                // Word 內容 HTML (嚴格參照 Docx 格式)
                const docContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset='utf-8'>
                        <style>
                            /* 頁面設定 */
                            @page {
                                size: 595.3pt 841.9pt; /* A4 */
                                margin: 1.0cm 1.5cm 1.0cm 1.5cm;
                            }
                            body { font-family: 'Calibri', 'Microsoft JhengHei', sans-serif; font-size: 11pt; }
                            
                            /* 表格樣式 */
                            table { border-collapse: collapse; width: 100%; }
                            td { vertical-align: top; padding: 2px; }
                            
                            /* 標頭樣式 */
                            .header-title { font-size: 20pt; font-weight: bold; color: #365F91; margin-bottom: 10px; }
                            .info-table td { padding-bottom: 5px; }
                            
                            /* 主表格樣式 */
                            .main-table { margin-top: 10px; border: 1px solid black; }
                            .main-table th { border: 1px solid black; background-color: #D9D9D9; font-weight: bold; text-align: center; padding: 5px; }
                            .main-table td { border: 1px solid black; padding: 8px; }
                            
                            /* 文字樣式 */
                            .bold { font-weight: bold; }
                            .right { text-align: right; }
                            .center { text-align: center; }
                            .red { color: red; }
                            
                            /* 簽名區 */
                            .signature-section { margin-top: 30px; }
                            .signature-line { border-bottom: 1px solid black; width: 200px; display: inline-block; margin-bottom: 5px; }
                        </style>
                    </head>
                    <body>
                    
                        <div>
                            <span class="header-title">Quotation</span>
                        </div>
                        <br>

                        <table class="info-table">
                            <tr>
                                <td width="10%" class="bold">To:</td>
                                <td width="50%">${data.school}</td>
                                <td width="10%" class="bold right">From:</td>
                                <td width="30%" class="right">Harry Leung</td>
                            </tr>
                            <tr>
                                <td class="bold">Attn:</td>
                                <td>${data.teacher}</td>
                                <td class="bold right">Date:</td>
                                <td class="right">${dateStr}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td></td>
                                <td class="bold right">Email:</td>
                                <td class="right">harryleung@pi-innovation.com.hk</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td></td>
                                <td class="bold right">Quotation #:</td>
                                <td class="right">${quoteNo}</td>
                            </tr>
                        </table>

                        <br>
                        <div>The following table:</div>

                        <table class="main-table">
                            <thead>
                                <tr>
                                    <th width="5%">No.</th>
                                    <th width="20%">Items</th>
                                    <th width="45%">Description</th>
                                    <th width="10%">Unit Price<br>(HK$)</th>
                                    <th width="8%">Qty</th>
                                    <th width="12%">Sub Total<br>(HK$)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="center">1</td>
                                    <td>${data.course}</td>
                                    <td>
                                        <span class="bold">課堂資料</span><br>
                                        課堂日期：${data.date}<br>
                                        課堂堂數：${data.lessons}堂<br>
                                        課堂時間：待定<br>
                                        每堂課時：1.5小時<br>
                                        學生年級：${data.grade}<br>
                                        學生人數：20人<br>
                                        課堂內容：請參閱下頁課程內容<br>
                                        <br>
                                        <span class="bold">本公司可提供</span><br>
                                        導師人數：1名導師及1名助教<br>
                                        如需加堂或帶隊參賽，費用按每堂收費收取<br>
                                        如需購買比賽相關材料/道具，費用將額外收取<br>
                                        <br>
                                        <span class="bold">需由貴校提供</span><br>
                                        無人機教材<br>
                                        平板電腦以供操控及編程無人機用途
                                    </td>
                                    <td class="center">${data.price}<br>(每堂)</td>
                                    <td class="center">${data.lessons}<br>(堂)</td>
                                    <td class="center">${data.total}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="margin-top: 15px;">
                            <span class="bold" style="text-decoration: underline;">Remarks:</span>
                            <ol style="margin-top: 5px; padding-left: 20px;">
                                <li>Please sign and chop at the right concern space for the acceptance of the service/products</li>
                                <li>This quotation is valid until 2 months after the issued date stated on this quotation</li>
                            </ol>
                        </div>

                        <div class="signature-section">
                            <table width="100%">
                                <tr>
                                    <td width="50%" valign="bottom">
                                        </td>
                                    <td width="50%" class="right" valign="top">
                                        <div style="text-align: left; display: inline-block; width: 200px;">
                                            <span class="bold">Prepared By</span><br>
                                            <br><br><br><br>
                                            <div style="border-bottom: 1px solid black; width: 100%;"></div>
                                            Harry Leung<br>
                                            Director<br>
                                            Date: ${dateStr}
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>

                    </body>
                    </html>
                `;

                // 下載 Word 檔
                const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Quotation_${quoteNo}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                status.innerText = "下載成功！";
                status.style.color = "green";

            } catch (err) {
                console.error(err);
                status.innerText = "錯誤: " + err.message;
                status.style.color = "red";
            } finally {
                btn.disabled = false;
            }
        }

        // CSV 解析函數
        function parseCSV(text) {
            const rows = [];
            text.split('\n').forEach(line => {
                const row = [];
                let inQuote = false;
                let buffer = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        row.push(buffer.trim());
                        buffer = '';
                    } else {
                        buffer += char;
                    }
                }
                row.push(buffer.trim());
                rows.push(row);
            });
            return rows.map(r => r.map(c => c.replace(/^"|"$/g, '').replace(/""/g, '"')));
        }
    </script>
</body>
</html>
